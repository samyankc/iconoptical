<!DOCTYPE html>

<html>

<head>
    <title>HCV Referral</title>
    <meta charset='UTF-8'>
    <meta name='viewport'
        content='width=device-width, height=device-height, initial-scale=1.0, minimum-scale=1.0, user-scalable=0'>
    <script src='JS/jquery-3.6.4.min.js'></script>
    <style>
        body {
            width: 100vw;
            border: 0;
            padding: 0;
            margin: 0;
        }

        .flex-container {
            display: flex;
            flex-flow: row;
            flex-wrap: wrap;
        }

        .center {
            max-width: 600px;
            margin: 0 auto;
            width: auto;
        }

        input,
        button {
            width: 40vw;
            max-width: 40%;
            flex-basis: 40%;
            margin: 1vh auto;
            padding: 18px 2%;
            color: black;
            font-size: 18px;
            font-weight: 900;
            text-shadow: 1px 0 white, -1px 0 white, 0 1px white, 0 -1px white;
            border: 0;
        }

        input {
            border: 1px solid grey;
            border-radius: 10px;
            padding: 18px 2vw 18px 4vw;
        }

        .colour-green {
            background-color: rgb(118, 224, 91);
        }

        .card[data-status="待覆驗"],
        .colour-blue {
            background-color: rgb(98, 201, 236);
        }

        .card[data-status="已覆驗"],
        .colour-yellow {
            background-color: rgb(235, 235, 88);
        }

        button:disabled,
        .colour-grey {
            background-color: rgb(90, 90, 90);
        }

        .colour-pink {
            background-color: rgb(226, 153, 215);
        }

        .colour-red {
            background-color: rgb(217, 72, 72);
        }

        .card {
            flex-basis: 40%;
            width: 40vw;
            max-width: 40%;
            margin: 1vh auto;
            padding: 1%;
            font-weight: 600;
            background-color: rgba(144, 220, 230, 0.4);
            box-shadow: 2px 2px 5px grey;
        }

        dialog{
            max-width: 400px;
        }

        .invisible {
            visibility: hidden;
        }

        .hidden {
            display: none;
        }
    </style>
</head>

<body>
    <div id='card-template' class='hidden card'></div>

    <dialog id='registration-form'>
        <form onsubmit='AsyncSubmit(this); return false;' class='center flex-container'>
            <input type="hidden" name='action' value='register'>
            <input type='text' name='name' placeholder='姓名' required>
            <input type='text' name='phone' placeholder='電話' required>
            <input type='text' name='claim' placeholder='HCV金額' required>
            <input type='text' name='invoice' placeholder='單號' required>
            <input type='text' name='pickup' placeholder='取貨分店' required>
            <input type='text' name='remark' placeholder='備註(可不填)'>
            <button class='colour-green' type='submit'>登記</button>
            <button class='colour-grey' type='button' onclick='CloseModal(this)'>取消</button>
        </form>
    </dialog>

    <dialog id='done-form'>
        <form onsubmit='AsyncSubmit(this); return false;' class='center flex-container'>
            <input type="hidden" name='action' value='done'>
            <input type="hidden" name='key' class='key-holder'>
            <button class='button-done colour-yellow' type='submit'>完成覆驗</button>
            <button class='colour-grey' type='button' onclick='CloseModal(this)'>取消</button>
        </form>
    </dialog>

    <dialog id='undo-form'>
        <form onsubmit='AsyncSubmit(this); return false;' class='center flex-container'>
            <input type="hidden" name='action' value='undo'>
            <input type="hidden" name='key' class='key-holder'>
            <button class='button-undo colour-blue' type='submit'>回復待覆驗</button>
            <button class='colour-grey' type='button' onclick='CloseModal(this)'>取消</button>
        </form>
    </dialog>

    <dialog id='empty-form'>
        <form class='center flex-container'>
            <button class='colour-grey' type='submit' formmethod='dialog'>取消</button>
        </form>
    </dialog>

    <div id='dash-board' style='background-color: white; font-size: 10px; position: fixed; top:0;'>

    </div>
    <div style='height: 20px'></div>
    <div class="center flex-container">
        <button class="colour-green" onclick="$('#registration-form')[0].showModal()">登記</button>
        <button class="colour-pink" id='button-check-all' onclick='CardOnlyShow("待覆驗","已覆驗")'>查看全部</button>
        <button class="colour-blue" onclick='CardOnlyShow("待覆驗")'>待覆驗</button>
        <button class="colour-yellow" onclick='CardOnlyShow("已覆驗")'>已覆驗</button>
    </div>
    <div id='output' class="center flex-container"></div>
    <div class='center' style='margin-top: 2em;'>
        <a href='https://docs.google.com/spreadsheets/d/1Kfv_AOscXF1e8sjHO1Yg-cDzM4J5ScV1B8HsUV5EfQo/edit?usp=sharing'
            target='_blank' style='text-decoration: none;'>Link to Google Sheet</a>
    </div>
</body>

<script>

    var ActionURL = 'https://script.google.com/macros/s/AKfycbxerZk_XKvlMP818IMUNK9elOhSEMObsW2HqiCzvgXrAUJHCw5ac_wqH9ArqkvVX0Sg/exec'

    var DashBoardDevice = $('#dash-board')
    function DashBoard(Content) { DashBoardDevice.html(Content) }

    var OutputDevice = $('#output')
    function Output(Content) { OutputDevice.html(Content) }

    function ConvertToMapArray(CSV) {
        const HeaderRow = CSV[0]
        var MapArray = []
        var MapElement = {}
        for (const FieldName of HeaderRow) MapElement[FieldName] = {}

        for (const Row in CSV) {
            if (Row > 0) {
                var ResultantMap = structuredClone(MapElement)
                for (const Col in HeaderRow) ResultantMap[HeaderRow[Col]] = CSV[Row][Col]
                MapArray.push(ResultantMap)
            }
        }
        return MapArray
    }

    var DataBase = null
    function ReloadDataBase() {
        $('#button-check-all').attr('disabled', true)
        DashBoard('Loading DataBase...')
        $.get(ActionURL, { action: 'list' }, (R) => {
            DataBase = ConvertToMapArray(R)
            DashBoard('Loading Complete.')
            Output('')
            for (const Entry of DataBase) MakeCard(Entry)
            $('#button-check-all').removeAttr('disabled')
        })
    }
    ReloadDataBase()

    function CloseModal(that) {
        $(that).parents('dialog').last()[0].close()
    }

    function CardClone() {
        return $('#card-template').clone(true).removeClass('hidden').removeAttr('id')
    }

    function MakeCard(e) {
        var NewCard = CardClone().attr('data-key', e.Key).attr('data-status', e.Status)
        // .addClass((e.Status == "已覆驗" ? 'colour-yellow' : 'colour-blue'))
        var CardContent = `${e.Name}<br>${e.Phone}<br>$&nbsp;${e.Claim}<br>${e.Invoice}<br>${e.PickUp}取`
        if (e.Remark != null && e.Remark != '') CardContent += `<br>!! Remark:<br>${e.Remark}`
        NewCard.html(CardContent)

        var StatusFormName = { '待覆驗': 'done', '已覆驗': 'undo' }[e.Status] ?? 'empty'

        NewCard.on('click', () => {
            $(`#${StatusFormName}-form .key-holder`).attr('value', e.Key)
            $(`#${StatusFormName}-form`)[0].showModal()
        })

        NewCard.appendTo(OutputDevice)
    }

    function ReadTableMockData() {
        return [
            ["Key", "Name", "Phone", "Claim", "Invoice", "PickUp", "Status", "Remark"],
            [0, "Chan Tai Man", 91234567, 1500, "#101001", "太和", "", "123"],
            [1, "Wong Ming1", 92345678, 688, "#101123, #101122", "大埔", "待覆驗", ""],
            [2, "Wong Ming2", 92345678, 688, "#101123, #101122", "大埔", "已覆驗", "321"],
            [3, "Wong Ming3 this is a very long name", 92345678, 688, "#101123, #101122", "大埔", "待覆驗", ""]
        ]
    }

    function ReadTableMock() {
        var L = (cb) => {
            cb(ReadTableMockData())
            return ReadTableMock()
        }
        return {
            fail: ReadTableMock, // no-op
            done: L,
            then: L
        }
    }

    function AsyncSubmit(Form) {
        CloseModal(Form)
        DashBoard('Making Request...')
        $.get(ActionURL, $(Form).serialize(), (e) => { DashBoard(''); ReloadDataBase() })
    }

    function ReadTable() {
        // return ReadTableMock()
        return $.get(ActionURL, { action: 'list' })
    }

    function CardOnlyShow(...Status) {
        $('.card').addClass('hidden')
        for (const S of Status) {
            $(`.card[data-status='${S}']`).removeClass('hidden')
        }

    }


</script>

</html>